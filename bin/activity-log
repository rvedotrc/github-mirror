#!/usr/bin/env ruby

require 'json'
require 'time'

def date_of_commit(commit)
  commit.each do |t|
    break if t == "\n"
    if m = t.match(/^Date:\s*(.*)$/)
      return Time.parse m[1]
    end
  end
end

def do_permutation(entry, permutation, is_added)
  t = entry["t"]
  dir = entry["local_dir"]
  file = entry["file"].first.chomp

  access, secret = permutation

  puts "#{is_added ? "+" : "-"} #{t} #{dir} #{file} #{access} #{secret}"
end

# The output of analyse-commits.  Wish an array wrapper.
data = JSON.parse($stdin.read)

data.each do |entry|
  t = date_of_commit entry["commit"]
  entry["t"] = t
end

data.sort_by! {|e| e["t"]}

data.each do |entry|
  entry["old_permutations"].each do |p|
    do_permutation entry, p, false
  end

  entry["new_permutations"].each do |p|
    do_permutation entry, p, true
  end
end
