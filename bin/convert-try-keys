#!/usr/bin/env ruby

# One-off script to convert from try-keys.json to aws-key-pairs.json

$: << "lib"
require 'github_mirror'
require 'json'

file_data = JSON.parse(IO.read "var/try-keys.json")
now = Time.now

bak = file_data["by_access_key"].each_entry.map do |ak, key_data|

  o = GithubMirror::AwsKeyPair.init_secret_not_found(ak, '')

  if tried = key_data.delete("tried_secret_access_keys")
    o = GithubMirror::AwsKeyPair.init_secret_not_found(ak, tried.first)
    tried.each do |sak|
      o.add_secret_not_found(sak)
    end
  end

  if sak = key_data.delete("secret_access_key")
    arn = key_data.delete "user_arn"
    arn ||= "not captured"
    sf = key_data.delete "secret_found"
    if sf and not sf.empty?
      sf.each do |t|
        o.add_secret_found(sak, arn, Time.parse(t))
      end
    else
      o.add_secret_found(sak, arn, now)
    end
  end

  if bad_key = key_data.delete("bad_key")
    if bad_key.empty?
      o.add_bad_access_key(now)
    else
      bad_key.each do |t|
        o.add_bad_access_key(Time.parse t)
      end
    end
  end

  [ ak, o.to_h ]
end.to_h

out = { "by_access_key" => bak }

puts JSON.pretty_generate(out)

# eof convert-try-keys
