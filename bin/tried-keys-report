#!/usr/bin/env ruby

require 'json'

@state_file = "var/try-keys.json"

def load_state
  begin
    JSON.parse(IO.read @state_file)
  rescue Errno::ENOENT
    {}
  end
end

state = load_state
state["by_access_key"] ||= {}

state["by_access_key"].each do |key, info|
  bad = info.has_key? "bad_key"
  found = info.has_key? "secret_access_key"
  user = info["user_arn"]
  acc = info["account_aliases"]

  desc = if found
           bad ? "killed" : "alive"
         else
           bad ? "bad" : "unknown"
         end

  puts "#{key}\t#{desc}\t#{user || '-'}"
end
