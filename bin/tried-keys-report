#!/usr/bin/env ruby

require 'json'
require 'digest'

@state_file = "var/try-keys.json"
account_list = "var/aws-accounts.json"
a = JSON.parse(IO.read account_list)

def load_state
  begin
    JSON.parse(IO.read @state_file)
  rescue Errno::ENOENT
    {}
  end
end

state = load_state
state["by_access_key"] ||= {}

@fast_run = JSON.parse(IO.read "var/fast-run.json")
def show_matching_commits(access_key_id)
  @fast_run.each do |r|
    aws = r["aws_credentials_commits"]
    if aws
      aws["log"].map do |c|

        this_key = %w[ old_permutations new_permutations ].any? do |pk|
          c["possible_secrets"][pk].any? {|comb| comb.first == access_key_id }
        end

        if this_key

          org = r["git_url"].split('/')[3]
          repo = r["git_url"].split('/')[4].sub(/\.git$/, "")
          hash = c["possible_secrets"]["commit"]["commit"]
          path = c["possible_secrets"]["file"]["filename"]
          file_md5 = Digest::MD5.hexdigest(path)
          url = "https://github.com/#{org}/#{repo}/commit/#{hash}\#diff-#{file_md5}"

          privacy = if r["is_private"]
                      "private"
                    else
                      "public"
                    end

          puts "  " + privacy + " " + c["possible_secrets"]["commit"]["time"]["iso"] + " " + url
        end # if this key
      end # log
    end # if aws
  end # repo
end

repos = JSON.parse(IO.read "var/list-repos.json")

state["by_access_key"].each do |key, info|
  bad = info.has_key? "bad_key"
  found = info.has_key? "secret_access_key"
  user = info["user_arn"]

  acc = info["account_aliases"] || []

  desc = if found
           bad ? "killed" : "alive"
         else
           bad ? "bad" : "unknown"
         end

  if user
    account_id = user.split(/:/)[4]
    account_info = a["accounts"].find {|acc| acc["account_id"] == account_id}
  else
    account_info = nil
  end

  live_date = (info["secret_found"] || []).first || "-"
  dead_date = (info["bad_key"] || []).first || "-"

  puts "#{key}\t#{desc}\t#{live_date}\t#{dead_date}\t#{user || '-'}\t#{account_info ? account_info["account_name"] : '-'}"
  puts ""
  show_matching_commits key
  puts ""
end
