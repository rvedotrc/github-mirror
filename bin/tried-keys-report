#!/usr/bin/env ruby

require 'json'
require 'digest'
require 'forge-helper'

def get_accounts
  r = ForgeHelper.new.connect("https://aws-accounts.tools.bbc.co.uk/v1/accounts").get
  JSON.parse(r.body)
end

@accounts = get_accounts["accounts"]

@state_file = "var/aws-key-pairs.json"

def load_state
  begin
    JSON.parse(IO.read @state_file)
  rescue Errno::ENOENT
    {}
  end
end

state = load_state
state["by_access_key"] ||= {}

@fast_run = JSON.parse(IO.read "var/fast-run.json") # details of where each key was found
def show_matching_commits(access_key_id)
  @fast_run.each do |r|
    aws = r["aws_credentials_commits"]

    # Might only have error, not log
    # (would benefit from a data class here of course)
    if aws and aws["log"]
      aws["log"].map do |c|

        this_key = %w[ old_permutations new_permutations ].any? do |pk|
          c["possible_secrets"][pk].any? {|comb| comb.first == access_key_id }
        end

        if this_key

          org = r["git_url"].split('/')[3]
          repo = r["git_url"].split('/')[4].sub(/\.git$/, "")
          hash = c["possible_secrets"]["commit"]["commit"]
          path = c["possible_secrets"]["file"]["filename"]
          file_md5 = Digest::MD5.hexdigest(path)
          url = "https://github.com/#{org}/#{repo}/commit/#{hash}\#diff-#{file_md5}"

          privacy = if r["is_private"]
                      "private"
                    else
                      "public"
                    end

          puts "  " + privacy + " " + c["possible_secrets"]["commit"]["time"]["iso"] + " " + url
        end # if this key
      end # log
    end # if aws
  end # repo
end

state["by_access_key"].each do |key, info|
  user = info["user_arn"]
  desc = info["state"]

  if user
    account_id = user.split(/:/)[4]
    account_info = @accounts[account_id]
  else
    account_info = nil
  end

  live_date = info["date_secret_found_first"] || "-"
  dead_date = info["date_bad"] || "-"

  puts "#{key}\t#{desc}\t#{live_date}\t#{dead_date}\t#{user || '-'}\t#{account_info ? account_info["name"] : '-'}"
  puts ""
  show_matching_commits key
  puts ""
end
