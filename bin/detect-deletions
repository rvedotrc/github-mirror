#!/usr/bin/env ruby
# vi: set ts=2 sw=2 :

# Look for IDs under BARE_DIR/id that are no longer in repositories.json
# Look for full names under BARE_DIR/full_name that are no longer in repositories.json
# Look for full names under CHECKOUT_DIR that are no longer in repositories.json

$: << 'lib'

require 'json'

require 'command_runner'

BARE_DIR = './var/github'
CHECKOUT_DIR = './var/checkout'

repositories = JSON.parse(IO.read 'var/repositories.json')

Dir.glob("#{CHECKOUT_DIR}/full_name/*/*").each do |checkout|
  full_name = checkout.sub("#{CHECKOUT_DIR}/full_name/", '')
  repo = repositories.find {|r| r['full_name'] == full_name}
  next if repo

  result = CommandRunner.do_system!(
    'git', 'status', '--porcelain',
    chdir: checkout,
  )

  if result.log == ''
    puts "rm -rf #{checkout}"
    FileUtils.rm_rf checkout
  else
    puts "NOT deleting #{checkout} because it's not clean"
  end
end

# eof
